---
import { Icon } from "astro-icon/components";
import { Image } from "astro:assets";
import { getCollection } from "astro:content";
import { format, isPast } from "date-fns";
import { nb } from "date-fns/locale";
import Link from "../../components/Link.astro";
import Tag from "../../components/Tag.astro";
import { RSS_ICON } from "../../icons";
import Layout from "../../layouts/Layout.astro";

const posts = await getCollection("drypp");

// Sort posts by date, filtering out posts without required fields
const sortedPosts = posts
  .filter((post) => (import.meta.env.DEV ? true : isPast(post.data.pubDate)))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const description = "En blogg med drypp fra musikk og podkast";
const title = "Drypp";
---

<Layout title={title} description={description} showRssLink={true}>
  <div class="mx-auto max-w-7xl space-y-8">
    <div class="flex items-end gap-2">
      <h1>{title}</h1>
      <a
        href="/drypp/rss.xml"
        class="group flex items-center justify-center gap-1"
        title="Abonner pÃ¥ RSS-feed"
      >
        <Icon
          name={RSS_ICON}
          size={24}
          class="block transition-transform group-hover:scale-110"
        />
        <div class="text-base">RSS</div>
      </a>
    </div>
    <div>
      <p class="text-gray-500">{description}</p>
    </div>
    <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3 lg:gap-12">
      {
        sortedPosts.map((post) => (
          <article transition:name={`post-${post.id}`}>
            {post.data.image && (
              <Link href={`/drypp/${post.id}`} noWave>
                <div class="group relative aspect-video overflow-hidden">
                  <Image
                    src={post.data.image}
                    width={400}
                    height={400}
                    quality={100}
                    alt={post.data.title}
                    class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
                  />
                </div>
              </Link>
            )}
            <div class="space-y-2">
              <h2>
                <Link href={`/drypp/${post.id}`}>{post.data.title}</Link>
              </h2>
              <p class="text-gray-500">{post.data.description}</p>
              {post.data.tags && post.data.tags.length > 0 && (
                <div class="flex flex-wrap gap-2">
                  {post.data.tags.map((tag) => (
                    <Tag tag={tag} />
                  ))}
                </div>
              )}
              <time
                datetime={post.data.pubDate.toISOString()}
                class="text-gray-400"
              >
                {format(post.data.pubDate, "d. MMMM yyyy", { locale: nb })}
              </time>
            </div>
          </article>
        ))
      }
    </div>
  </div>
</Layout>

<style>
  ::view-transition-old(drypp-content),
  ::view-transition-new(drypp-content) {
    animation: none;
    mix-blend-mode: normal;
  }

  ::view-transition-old(drypp-content) {
    z-index: 1;
  }
  ::view-transition-new(drypp-content) {
    z-index: 2;
  }

  .dark::view-transition-old(drypp-content) {
    z-index: 2;
  }
  .dark::view-transition-new(drypp-content) {
    z-index: 1;
  }

  ::view-transition-old(drypp-content),
  ::view-transition-new(drypp-content) {
    animation: slide 0.3s ease-in-out;
  }

  @keyframes slide {
    from {
      transform: translateX(100%);
    }
    to {
      transform: translateX(0);
    }
  }
</style>
