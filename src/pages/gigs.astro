---
import Layout from "../layouts/Layout.astro";
import gigs from "../data/gigs.json";
import { orderBy, partition, groupBy } from "lodash-es";
import GigRow from "../components/GigRow.astro";
import { format } from "date-fns";

type Gig = {
  date: string;
  venue: string;
  venueUrl: string;
  city: string;
  artist: string;
  artistUrl: string;
  eventDescription: string;
  eventUrl: string;
  facebookUrl: string;
  ticketsUrl: string;
  createdAt: string;
};

const sortedGigs: Gig[] = orderBy(gigs, "date", "desc");

const groupGigsByYear = (gigs: Gig[]) => {
  return groupBy(gigs, (gig) => new Date(gig.date).getFullYear());
};

const sortYearsDesc = (years: Record<string, Gig[]>) => {
  return orderBy(Object.entries(years), ([year]) => Number(year), "desc");
};
---

<Layout title="Upcoming Gigs">
  <h1 class="text-3xl font-bold mb-8">Gigs</h1>
  {
    sortYearsDesc(groupGigsByYear(sortedGigs)).map(
      ([year, yearGigs], index) => (
        <details class="group mb-4" open={index === 0}>
          <summary class="text-lg font-medium cursor-pointer hover:text-gray-600 dark:hover:text-gray-300">
            {year}
          </summary>
          <div class="grid grid-rows-[0fr] group-open:grid-rows-[1fr] transition-[grid-template-rows] duration-300">
            <div class="overflow-hidden">
              <div class="mt-2">
                <!-- Header -->
                <div class="grid grid-cols-[120px_1fr_1fr] gap-4 px-6 py-3 bg-gray-50 dark:bg-gray-800 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                  <div>Date</div>
                  <div>Artist & Venue</div>
                  <div>Description</div>
                </div>
                <!-- Content -->
                <div class="divide-y divide-gray-200 dark:divide-gray-700">
                  {yearGigs.map((gig: Gig) => (
                    <div class="grid grid-cols-[120px_1fr_1fr] gap-4 px-6 py-4 hover:bg-gray-50 dark:hover:bg-gray-800">
                      <time datetime={gig.date} class="text-sm text-gray-500 dark:text-gray-400 whitespace-nowrap">
                        {format(new Date(gig.date), "dd MMM yyyy")}
                      </time>
                      <div>
                        <div class="font-medium text-gray-900 dark:text-white">{gig.artist}</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">{gig.venue}</div>
                      </div>
                      <div class="text-sm text-gray-500 dark:text-gray-400">
                        {gig.eventDescription}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        </details>
      ),
    )
  }
</Layout>
