---
import { format } from "date-fns";
import { groupBy, orderBy } from "lodash-es";
import gigs from "../data/gigs.json";
import Layout from "../layouts/Layout.astro";

type Gig = {
  date: string;
  venue: string;
  venueUrl: string;
  city: string;
  artist: string;
  artistUrl: string;
  eventDescription: string;
  eventUrl: string;
  facebookUrl: string;
  ticketsUrl: string;
  createdAt: string;
};

const sortedGigs: Gig[] = orderBy(gigs, "date", "desc");

const groupGigsByYear = (gigs: Gig[]) => {
  return groupBy(gigs, (gig) => new Date(gig.date).getFullYear());
};

const sortYearsDesc = (years: Record<string, Gig[]>) => {
  return orderBy(Object.entries(years), ([year]) => Number(year), "desc");
};
---

<Layout title="Upcoming Gigs">
  <h1 class="mb-8 text-3xl font-bold">Gigs</h1>
  {
    sortYearsDesc(groupGigsByYear(sortedGigs)).map(
      ([year, yearGigs], index) => (
        <details class="group mb-4" open={index === 0}>
          <summary class="cursor-pointer text-lg font-medium hover:text-gray-600">
            {year}
          </summary>
          <div class="grid grid-rows-[0fr] transition-[grid-template-rows] duration-300 group-open:grid-rows-[1fr]">
            <div class="overflow-hidden">
              <div class="mt-2">
                <div class="grid grid-cols-[120px_1fr_1fr] gap-4 bg-gray-50 px-6 py-3 text-xs font-medium tracking-wider text-gray-500 uppercase">
                  <div>Date</div>
                  <div>Artist & Venue</div>
                  <div>Description</div>
                </div>
                <div class="divide-y divide-gray-200">
                  {yearGigs.map((gig: Gig) => (
                    <div class="grid grid-cols-[120px_1fr_1fr] gap-4 px-6 py-4 hover:bg-gray-50">
                      <time
                        datetime={gig.date}
                        class="text-sm whitespace-nowrap text-gray-500"
                      >
                        {format(new Date(gig.date), "dd MMM yyyy")}
                      </time>
                      <div>
                        <div class="font-medium text-gray-900">
                          {gig.artist}
                        </div>
                        <div class="text-sm text-gray-500">{gig.venue}</div>
                      </div>
                      <div class="text-sm text-gray-500">
                        {gig.eventDescription}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        </details>
      ),
    )
  }
</Layout>
