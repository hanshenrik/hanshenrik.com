---
import { Icon } from "astro-icon/components";
import { PIANO_PLUKK_ICON } from "../constants";

interface Props {
  class?: string;
}

const { class: className }: Props = Astro.props;

const noteIcons = [
  "arcticons:music",
  "arcticons:emoji-multiple-musical-notes",
  "arcticons:lineage-music",
  "arcticons:line-music",
  "arcticons:music-alt-3",
  "arcticons:music-alt-1",
  "arcticons:nintendo-music",
  "arcticons:huawei-music",
  "arcticons:music-you",
  "arcticons:fossify-musicplayer",
  "arcticons:emoji-musical-note",
  "arcticons:emoji-musical-score",
  "arcticons:applemusic",
  "arcticons:samsung-music",
  "arcticons:unpopular-music-player",
];

const soundFiles = Array.from({ length: 31 }, (_, i) => {
  const num = i + 1;
  return `${num.toString().padStart(2, "0")}.mp3`;
});
---

<div class:list={["relative", className]}>
  <div class="pointer-events-none absolute inset-0">
    {
      noteIcons.map((icon) => (
        <Icon
          class="piano-plukk-note z-50 hidden text-gray-400 opacity-0 transition-opacity duration-[3s] ease-linear"
          name={icon}
          size={48}
          stroke-width={1.5}
        />
      ))
    }
  </div>
  <button
    class="mt-0.5 inline-flex items-center gap-2 rounded-full p-2 text-sm text-gray-700 transition-colors duration-200 hover:bg-gray-200"
    id="piano-plukk-trigger"
  >
    <Icon name={PIANO_PLUKK_ICON} size={20} />
  </button>
</div>

<style>
  .piano-plukk-note {
    position: fixed;
  }
</style>

<script define:vars={{ soundFiles }}>
  const button = document.getElementById("piano-plukk-trigger");
  const notes = document.querySelectorAll(".piano-plukk-note");
  const audioCache = new Map();
  let previousFile = "";

  // Preload all audio files
  soundFiles.forEach((file) => {
    const audio = new Audio(`/audio/pianoplukk/${file}`);
    audio.preload = "auto";
    audioCache.set(file, audio);
  });

  function showNote(note) {
    const x = Math.random() * (window.innerWidth - 48);
    const y = Math.random() * (window.innerHeight - 48);

    note.setAttribute("style", `left: ${x}px; top: ${y}px;`);
    note.classList.remove("hidden");
    // Force a reflow to ensure the transition works
    note.offsetHeight;
    note.classList.remove("opacity-0");

    setTimeout(() => {
      note.classList.add("opacity-0");
      setTimeout(() => note.classList.add("hidden"), 3000);
    }, 1);
  }

  function playRandomSound() {
    const filteredFiles = soundFiles.filter((file) => file !== previousFile);
    const randomFile =
      filteredFiles[Math.floor(Math.random() * filteredFiles.length)];
    previousFile = randomFile;

    const audio = audioCache.get(randomFile).cloneNode();
    audio.play();

    audio.addEventListener("ended", () => {
      const index = Array.from(audioCache.values()).indexOf(audio);
      if (index > -1) {
        audioCache.delete(soundFiles[index]);
      }
    });
  }

  button?.addEventListener("click", () => {
    const randomNote = notes[Math.floor(Math.random() * notes.length)];
    showNote(randomNote);
    playRandomSound();
  });
</script>
