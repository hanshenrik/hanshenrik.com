---
import { Image } from "astro:assets";

interface Props {
  recordings: any[];
  title: string;
  playerId: string;
}

const { recordings, title, playerId } = Astro.props;
---

<div>
  <h3 class="mb-4">{title}</h3>
  <div class="max-w-full rounded-lg border border-gray-200 bg-white shadow-sm">
    <!-- Player Controls -->
    <div class="flex items-center gap-4 border-b border-gray-100 p-4">
      <button
        id={`prev-track-${playerId}`}
        class="rounded-full p-2 text-gray-600 hover:bg-gray-100"
        aria-label="Previous track"
      >
        ⏮️
      </button>
      <button
        id={`play-pause-${playerId}`}
        class="rounded-full p-2 text-gray-600 hover:bg-gray-100"
        aria-label="Play/Pause"
      >
        ⏯️
      </button>
      <button
        id={`next-track-${playerId}`}
        class="rounded-full p-2 text-gray-600 hover:bg-gray-100"
        aria-label="Next track"
      >
        ⏭️
      </button>
      <div class="min-w-0 flex-1">
        <div
          class="text-sm font-medium break-words text-gray-900"
          id={`now-playing-${playerId}`}
        >
          Select a track to play
        </div>
        <div
          class="text-xs break-words text-gray-500"
          id={`now-playing-artist-${playerId}`}
        >
        </div>
      </div>
    </div>
    <!-- Track List -->
    <div class="max-h-[420px] divide-y divide-gray-100 overflow-y-auto">
      {
        recordings.map(({ data }, index) => (
          <button
            class="flex w-full items-center gap-4 p-3 text-left hover:bg-gray-50"
            data-track-index={index}
            data-player-id={playerId}
          >
            <div class="flex min-w-0 flex-1 items-center gap-4">
              {data.image && (
                <div class="relative h-12 w-12 flex-shrink-0 overflow-hidden rounded">
                  <Image
                    src={data.image}
                    width={48}
                    height={48}
                    quality={100}
                    alt={`${data.artist} - ${data.name}`}
                    class="h-full w-full object-cover"
                  />
                </div>
              )}
              <div class="min-w-0 flex-1">
                <h3 class="font-medium break-words text-gray-900">
                  {data.name}
                </h3>
                <p class="text-sm break-words text-gray-600">{data.artist}</p>
              </div>
              <div
                class="flex-shrink-0 opacity-0 transition-opacity duration-200"
                data-playing-indicator
              >
                ⏸️
              </div>
              {data.localFile && (
                <source
                  src={`audio/recordings/${data.localFile.type}/${data.localFile.src}`}
                  type={`audio/${data.localFile.format ? data.localFile.format : "mpeg"}`}
                />
              )}
            </div>
          </button>
        ))
      }
    </div>
  </div>
</div>

<script define:vars={{ playerId }}>
  const tracks = document.querySelectorAll(
    `[data-track-index][data-player-id="${playerId}"]`,
  );
  const playPauseBtn = document.getElementById(`play-pause-${playerId}`);
  const prevBtn = document.getElementById(`prev-track-${playerId}`);
  const nextBtn = document.getElementById(`next-track-${playerId}`);
  const nowPlaying = document.getElementById(`now-playing-${playerId}`);
  const nowPlayingArtist = document.getElementById(
    `now-playing-artist-${playerId}`,
  );

  if (
    !playPauseBtn ||
    !prevBtn ||
    !nextBtn ||
    !nowPlaying ||
    !nowPlayingArtist
  ) {
    throw new Error("Required player elements not found");
  }

  let currentTrack = null;
  let currentIndex = -1;
  const audio = new Audio();

  function updateNowPlaying(track) {
    const name = track.querySelector("h3")?.textContent ?? "";
    const artist = track.querySelector("p")?.textContent ?? "";
    nowPlaying.textContent = name;
    nowPlayingArtist.textContent = artist;
  }

  function setActiveTrack(track) {
    tracks.forEach((t) => {
      t.classList.remove("bg-gray-50");
      const indicator = t.querySelector("[data-playing-indicator]");
      if (indicator) {
        indicator.classList.remove("playing");
        indicator.classList.add("opacity-0");
      }
    });
    track.classList.add("bg-gray-50");
    const indicator = track.querySelector("[data-playing-indicator]");
    if (indicator) {
      indicator.classList.add("playing");
      indicator.classList.remove("opacity-0");
    }
  }

  function playTrack(index) {
    const track = tracks[index];
    const source = track.querySelector("source");
    if (!source?.src) return;

    // If clicking the currently playing track, toggle play/pause
    if (currentTrack === track) {
      togglePlayPause();
      return;
    }

    currentIndex = index;
    currentTrack = track;
    audio.src = source.src;
    audio.play();
    updateNowPlaying(track);
    setActiveTrack(track);
    playPauseBtn.textContent = "⏸️";
  }

  function togglePlayPause() {
    if (!currentTrack) return;

    if (audio.paused) {
      audio.play();
      playPauseBtn.textContent = "⏸️";
    } else {
      audio.pause();
      playPauseBtn.textContent = "⏯️";
    }
  }

  function playNext() {
    if (currentIndex < tracks.length - 1) {
      playTrack(currentIndex + 1);
    }
  }

  function playPrev() {
    if (currentIndex > 0) {
      playTrack(currentIndex - 1);
    }
  }

  // Event Listeners
  tracks.forEach((track, index) => {
    track.addEventListener("click", () => playTrack(index));
  });

  playPauseBtn.addEventListener("click", togglePlayPause);
  prevBtn.addEventListener("click", playPrev);
  nextBtn.addEventListener("click", playNext);

  audio.addEventListener("ended", playNext);
  audio.addEventListener("pause", () => {
    playPauseBtn.textContent = "⏯️";
    if (currentTrack) {
      const indicator = currentTrack.querySelector("[data-playing-indicator]");
      if (indicator) {
        indicator.classList.remove("playing");
      }
    }
  });
  audio.addEventListener("play", () => {
    playPauseBtn.textContent = "⏸️";
    if (currentTrack) {
      const indicator = currentTrack.querySelector("[data-playing-indicator]");
      if (indicator) {
        indicator.classList.add("playing");
      }
    }
  });
</script>
